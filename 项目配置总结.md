# LobeChat 项目配置总结

## 🚀 项目环境配置

### Docker 服务配置

- PostgreSQL 数据库
- MinIO 对象存储
- Casdoor 认证服务
- SearXNG 搜索服务

### 环境变量配置 (.env)

#### API Keys 配置

```bash
# OpenAI
OPENAI_API_KEY=你的密钥（支持多个，逗号分隔）
OPENAI_MODEL_LIST=gpt-4o,gpt-4o-mini-2024-07-18,o4-mini,gpt-5-chat-latest

# Claude (Anthropic)
ANTHROPIC_API_KEY=你的密钥
ANTHROPIC_MODEL_LIST=claude-3-haiku-20240307,claude-sonnet-4-20250514,claude-3-7-sonnet-20250219

# Gemini (Google)
GOOGLE_API_KEY=你的密钥
GOOGLE_MODEL_LIST=gemini-2.5-pro-preview-03-25,gemini-2.5-flash,gemini-2.5-pro

# Grok (xAI)
XAI_API_KEY=你的密钥
XAI_MODEL_LIST=grok-4-0709
```

#### API Key 轮换模式

```bash
API_KEY_SELECT_MODE=turn # turn(轮流) 或 random(随机)
```

#### 代理配置

```bash
# 本机命令行代理设置（推荐方式）
export https_proxy=http://127.0.0.1:7890
export http_proxy=http://127.0.0.1:7890
export all_proxy=socks5://127.0.0.1:7890
```

**重要说明**：

- 所有模型都**不需要**在 .env 中配置 PROXY_URL
- 只需在本机启动命令行代理即可
- 系统会自动通过命令行代理访问各个 API 服务

## 🎯 功能实现

### 1. Token 使用统计与拦截

**位置**: `/src/app/(backend)/webapi/chat/[provider]/route.ts`

- 实现了流式响应的 Token 统计
- 支持 OpenAI 格式的 usage 事件
- 在控制台输出详细的使用统计
- **拦截点**：可在此处添加 Token 用量检查和上传逻辑
- **上传功能**：预留了向外部服务上传统计数据的接口

### 2. DALL-E 图片生成配置

**主要配置文件**: `/src/tools/dalle/index.ts`

修改方法：

- 修改 `maxItems` 和 `minItems` 的数量（控制生成图片数量）
- 修改提示词中的数量描述（如 "create four of them" 改为 "create one of them"）
- 系统提示词中的限制说明也需要同步修改

其他相关文件：

- `/src/store/image/slices/generationConfig/initialState.ts` - DEFAULT_IMAGE_NUM
- `/src/server/routers/lambda/image.ts` - 图片生成逻辑

**重要**: 所有支持图片生成的模型都可以使用 DALL-E 3 的模式进行绘图

### 3. 工具配额控制

**实现位置**：

- `/src/services/chat/contextEngineering.ts` - 系统角色过滤
- `/src/services/chat/index.ts` - 工具准备阶段过滤
- `/src/store/chat/slices/aiChat/actions/generateAIChat.ts` - 生成时过滤

配额控制逻辑已预留，需实现 `getUserImageQuota()` 函数。

### 4. 默认模型配置

**位置**: `/packages/const/src/settings/`

- 默认对话模型: `gemini-2.5-flash`
- 默认提供商: `google`
- 标题生成专用: `gemini-2.5-flash`

### 5. API Key 管理器日志

**位置**: `/src/server/modules/ModelRuntime/apiKeyManager.ts`

添加了 API Key 选择日志，格式：

```
[API Key Manager] Selected key 1/2 (turn mode): sk-proj...xxxx
```

## 📋 界面配置

### "大家都在问" 功能

**配置位置**：

- 问题文本: `/src/locales/default/welcome.ts`
- 显示逻辑: `QuestionSuggest.tsx`
- 显示数量：移动端 2 个，桌面端 5 个
-
- `/src/app/(backend)/` - 后端 API 路由
- `/src/services/` - 服务层（客户端 / 服务器双模式）
- `/src/store/` - Zustand 状态管理
- `/packages/` - Monorepo 包
- `/src/tools/` - 内置工具系统
